
(function() {
  // Create chatbot styles
  const style = document.createElement('style');
  style.innerHTML = `
    .chatbase-bubble {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #6366f1;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      z-index: 9999;
      transition: all 0.3s ease;
    }
    .chatbase-bubble:hover {
      transform: scale(1.05);
    }
    .chatbase-bubble svg {
      width: 30px;
      height: 30px;
      fill: white;
    }
    .chatbase-container {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 380px;
      max-width: calc(100vw - 40px);
      height: 600px;
      max-height: calc(100vh - 120px);
      background: white;
      border-radius: 12px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.2);
      z-index: 9999;
      display: none;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .chatbase-header {
      padding: 16px;
      background-color: #6366f1;
      color: white;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chatbase-close {
      cursor: pointer;
      padding: 5px;
    }
    .chatbase-close svg {
      width: 16px;
      height: 16px;
      fill: white;
    }
    .chatbase-iframe {
      flex: 1;
      border: none;
      width: 100%;
      height: 100%;
    }
    @media (max-width: 480px) {
      .chatbase-container {
        bottom: 0;
        right: 0;
        width: 100%;
        height: 100%;
        max-height: 100vh;
        border-radius: 0;
      }
    }
  `;
  document.head.appendChild(style);

  // Initialize with config
  function initChatbase() {
    if (!window.chatbaseConfig) {
      console.error('Chatbase configuration not found');
      return;
    }

    const config = window.chatbaseConfig;
    const domain = config.domain || 'https://www.narevka.com';
    const chatbotId = config.chatbotId;
    const title = config.title || 'Chat with our AI';
    const primaryColor = config.primaryColor || '#6366f1';

    // Update bubble color
    style.innerHTML = style.innerHTML.replace(/#6366f1/g, primaryColor);

    // Create bubble button
    const bubble = document.createElement('div');
    bubble.className = 'chatbase-bubble';
    bubble.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM16 12.75H13.25V15.5C13.25 15.91 12.91 16.25 12.5 16.25C12.09 16.25 11.75 15.91 11.75 15.5V12.75H9C8.59 12.75 8.25 12.41 8.25 12C8.25 11.59 8.59 11.25 9 11.25H11.75V8.5C11.75 8.09 12.09 7.75 12.5 7.75C12.91 7.75 13.25 8.09 13.25 8.5V11.25H16C16.41 11.25 16.75 11.59 16.75 12C16.75 12.41 16.41 12.75 16 12.75Z"/>
      </svg>
    `;
    document.body.appendChild(bubble);

    // Create chat container
    const container = document.createElement('div');
    container.className = 'chatbase-container';
    container.innerHTML = `
      <div class="chatbase-header">
        <div>${title}</div>
        <div class="chatbase-close">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </div>
      </div>
      <iframe 
        class="chatbase-iframe" 
        src="${domain}/chatbot-iframe/${chatbotId}"
        title="${title}"
        allow="microphone"
      ></iframe>
    `;
    document.body.appendChild(container);

    // Add event listeners
    bubble.addEventListener('click', function() {
      container.style.display = 'flex';
      bubble.style.display = 'none';
    });

    container.querySelector('.chatbase-close').addEventListener('click', function() {
      container.style.display = 'none';
      bubble.style.display = 'flex';
    });
  }

  // Initialize on load if configuration is already available
  if (window.chatbaseConfig) {
    if (document.readyState === 'complete') {
      initChatbase();
    } else {
      window.addEventListener('load', initChatbase);
    }
  }
  
  // Setup API for later initialization
  window.chatbase = function(command, ...args) {
    if (command === 'init') {
      initChatbase();
    } else if (window.chatbase.q) {
      window.chatbase.q.push([command, ...args]);
    }
  };
})();
